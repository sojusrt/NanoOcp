version: 1.0.{build}

branches:
  only:
    - main
    - develop

image: Ubuntu

services:
  - docker

shallow_clone: true

init:
  - echo "Nothing required in init phase."

install:
  - echo "Nothing required in install phase."

build_script:
  - sh: |
      echo ">>> Pulling Ubuntu 24.04 Docker image..."
      docker pull ubuntu:24.04

      echo ">>> Starting Docker build environment..."
      docker run --rm \
        -v "$APPVEYOR_BUILD_FOLDER:/src" \
        -w /src \
        ubuntu:24.04 \
        /bin/bash -c "
          set -e

          echo '>>> Updating apt...'
          apt-get update -y

          echo '>>> Installing JUCE dependencies...'
          apt-get install -y \
            git build-essential \
            g++-11 gcc-11 make \
            libcurl4-openssl-dev \
            libfreetype6-dev libfontconfig1-dev \
            libasound2-dev libjack-jackd2-dev \
            ladspa-sdk \
            libx11-dev libxcomposite-dev libxcursor-dev libxext-dev \
            libxinerama-dev libxrandr-dev libxrender-dev libwebkit2gtk-4.1-dev \
            libglu1-mesa-dev mesa-common-dev

          echo '>>> Setting gcc/g++ default to gcc-11...'
          update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-11 100 \
            --slave /usr/bin/g++ g++ /usr/bin/g++-11 \
            --slave /usr/bin/gcov gcov /usr/bin/gcov-11

          echo '>>> Inside container: check for .git...'
          if [ -d /src/.git ]; then
            echo '>>> .git exists in /src (mounted workspace looks like a repo).'
          else
            echo '>>> .git is missing. Will clone repository into /src (preserving mounted path).'

            # Remove any extracted files left in /src (but be cautious)
            echo '>>> Cleaning /src'
            find /src -mindepth 1 -maxdepth 1 -exec rm -rf {} \;

            echo '>>> Cloning repo (recursive)...'
            git config --global --add safe.directory /src
            git clone --recursive "https://github.com/christianahrens/nanoocp.git" /src

            # If AppVeyor gives us the exact commit, check it out
            if [ -n "${APPVEYOR_REPO_COMMIT:-}" ]; then
              echo '>>> Checking out commit ${APPVEYOR_REPO_COMMIT} ...'
              git -C /src fetch --all --tags
              git -C /src checkout --force "${APPVEYOR_REPO_COMMIT}"
            fi
          fi

          echo '>>> Ensure submodules are present (git submodule update inside container)...'
          git -C /src submodule update --init --recursive || true

          echo '>>> Listing /src (short):'
          ls -la /src | sed -n '1,200p'

          echo '>>> Running Demo build script build_Demo.sh...'
          cd NanoOcp1Demo/Resources/Deployment/Linux
          chmod +x build_Demo.sh
          ./build_Demo.sh

          echo '>>> Build completed successfully inside Docker.'
        "

notifications:
  - provider: Email
    to:
      - christianahrens@me.com
      - "{{commitAuthorEmail}}"
    on_build_success: false
    on_build_failure: true
    on_build_status_changed: false
